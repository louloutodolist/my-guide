<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#111827" />
  <title>TodoOffline – Chat Style</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#121a2b; --panel-2:#0e1626;
      --text:#e5e7eb; --muted:#9ca3af; --accent:#22c55e; --accent-2:#60a5fa;
      --danger:#ef4444; --warning:#f59e0b; --border:#1f2937;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .app{display:flex; flex-direction:column; height:100%}

    /* Header */
    .header{
      position:sticky; top:0; z-index:3;
      background:linear-gradient(180deg,var(--panel) 0%, var(--panel-2) 100%);
      border-bottom:1px solid var(--border);
      padding:10px 14px; display:flex; align-items:center; gap:10px;
    }
    .title{font-weight:700; letter-spacing:.2px}
    .count{color:var(--muted); font-size:.9rem}

    /* Tasks area (top table) */
    .board{flex:1; overflow:auto; padding:10px; background:var(--panel-2)}
    .table-wrap{border:1px solid var(--border); border-radius:12px; overflow:hidden}
    table{width:100%; border-collapse:collapse; background:var(--panel)}
    thead th{
      position:sticky; top:0; background:var(--panel); z-index:1;
      text-align:left; font-weight:600; color:var(--muted); font-size:.9rem;
      padding:10px; border-bottom:1px solid var(--border);
    }
    tbody td{padding:10px; border-top:1px solid var(--border); vertical-align:middle}
    tbody tr.completed td{color:#9ca3af; text-decoration:line-through}
    .task-text{word-break:break-word}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:3px 8px; border-radius:999px; font-size:.8rem; border:1px solid var(--border); color:var(--muted);
    }
    .actions{display:flex; gap:6px; flex-wrap:wrap}
    button, .btn{
      border:1px solid var(--border); background:#111827; color:var(--text);
      padding:8px 10px; border-radius:10px; font-weight:600; cursor:pointer;
      transition:transform .05s ease, background .15s ease;
      touch-action:manipulation;
    }
    button:active{transform:translateY(1px)}
    .btn-small{padding:6px 8px; font-size:.9rem}
    .btn-ok{background:rgba(34,197,94,.15); border-color:#14532d}
    .btn-blue{background:rgba(96,165,250,.15); border-color:#1e3a8a}
    .btn-warn{background:rgba(245,158,11,.12); border-color:#7c2d12}
    .btn-danger{background:rgba(239,68,68,.14); border-color:#7f1d1d}
    .status-dot{width:10px; height:10px; border-radius:50%}
    .dot-green{background:var(--accent)}
    .dot-gray{background:#6b7280}

    /* Composer (bottom table) */
    .composer{
      position:sticky; bottom:0; z-index:3; padding:10px;
      background:linear-gradient(180deg,var(--panel-2) 0%, var(--panel) 100%);
      border-top:1px solid var(--border);
    }
    .composer .table-wrap{border-radius:14px}
    .row{display:flex; gap:8px; align-items:center}
    input[type="text"]{
      flex:1; padding:12px 14px; border-radius:10px; border:1px solid var(--border);
      background:#0b1220; color:var(--text);
    }
    .hint{font-size:.85rem; color:var(--muted)}
    .kbd{border:1px solid var(--border); padding:2px 6px; border-radius:6px; background:#0b1220; color:var(--muted)}

    /* Mobile tweaks */
    @media (max-width:480px){
      thead th:nth-child(3), tbody td:nth-child(3){display:none} /* hide created column on tiny screens */
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="title">TodoOffline</div>
      <div class="count" id="countLabel">0 open</div>
      <div style="margin-left:auto; display:flex; gap:6px">
        <button class="btn btn-small btn-warn" id="exportBtn" title="Download tasks JSON">Export</button>
        <label class="btn btn-small btn-blue" title="Import tasks JSON">
          Import <input id="importInput" type="file" accept="application/json" hidden>
        </label>
        <button class="btn btn-small btn-danger" id="clearDoneBtn" title="Remove all completed">Clear done</button>
      </div>
    </div>

    <!-- TOP: tasks table -->
    <div class="board">
      <div class="table-wrap">
        <table aria-label="Tasks">
          <thead>
            <tr>
              <th style="width:44px">#</th>
              <th>Task</th>
              <th style="width:140px">Created</th>
              <th style="width:220px">Actions</th>
            </tr>
          </thead>
          <tbody id="taskBody">
            <!-- rows injected -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- BOTTOM: input “chat” table -->
    <div class="composer">
      <div class="table-wrap" style="padding:10px; background:var(--panel)">
        <table style="width:100%">
          <tbody>
            <tr>
              <td style="width:44px; text-align:center">
                <span class="chip"><span class="status-dot dot-green"></span>New</span>
              </td>
              <td>
                <div class="row">
                  <input id="taskInput" type="text" placeholder="Type a task and press Enter…" autocomplete="off" />
                  <button id="addBtn" class="btn btn-ok">Add</button>
                </div>
                <div class="hint" style="margin-top:6px">
                  Tip: Press <span class="kbd">Enter</span> to add, or <span class="kbd">Shift</span>+<span class="kbd">Enter</span> for a newline while editing.
                </div>
              </td>
              <td style="width:160px">
                <div class="hint">Open: <span id="openCount">0</span> • Done: <span id="doneCount">0</span></div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    /************ Data ************/
    const KEY = "todooffline.v2.tasks";
    let tasks = load();

    function load(){
      try{ return JSON.parse(localStorage.getItem(KEY)) || [] }catch{ return [] }
    }
    function save(){
      localStorage.setItem(KEY, JSON.stringify(tasks));
      render();
    }
    function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36) }

    /************ Render ************/
    const bodyEl = document.getElementById("taskBody");
    const countLabel = document.getElementById("countLabel");
    const openCountEl = document.getElementById("openCount");
    const doneCountEl = document.getElementById("doneCount");

    function fmt(ts){
      const d = new Date(ts);
      return d.toLocaleString();
    }

    function render(){
      bodyEl.innerHTML = "";
      tasks.forEach((t, i) => {
        const tr = document.createElement("tr");
        if(t.completed) tr.classList.add("completed");

        // # column
        const tdIdx = document.createElement("td");
        tdIdx.textContent = String(i+1);
        tdIdx.style.textAlign = "center";

        // task text (or editor)
        const tdTask = document.createElement("td");
        tdTask.className = "task-text";

        if(t._edit){
          const ta = document.createElement("textarea");
          ta.value = t.text;
          ta.style.width = "100%";
          ta.style.minHeight = "64px";
          ta.style.borderRadius = "10px";
          ta.style.border = "1px solid var(--border)";
          ta.style.background = "#0b1220";
          ta.style.color = "var(--text)";
          ta.addEventListener("keydown", (e)=>{
            if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); commitEdit(t.id, ta.value.trim()); }
          });
          tdTask.appendChild(ta);
          setTimeout(()=>ta.focus(),0);
        }else{
          tdTask.textContent = t.text || "(empty)";
        }

        // created
        const tdCreated = document.createElement("td");
        tdCreated.textContent = fmt(t.created);

        // actions
        const tdAct = document.createElement("td");
        tdAct.className = "actions";
        const bDone = btn(t.completed ? "Undo" : "Complete", "btn-small btn-ok", () => toggleDone(t.id));
        const bEdit = btn(t._edit ? "Save" : "Edit", "btn-small btn-blue", () => {
          if(t._edit){
            // find textarea in this row
            const ta = tdTask.querySelector("textarea");
            commitEdit(t.id, (ta?.value || "").trim());
          }else{
            t._edit = true; save();
          }
        });
        const bDel = btn("Delete", "btn-small btn-danger", () => del(t.id));
        tdAct.append(bDone,bEdit,bDel);

        tr.append(tdIdx, tdTask, tdCreated, tdAct);
        bodyEl.appendChild(tr);
      });

      // counts
      const open = tasks.filter(t=>!t.completed).length;
      const done = tasks.length - open;
      countLabel.textContent = `${open} open`;
      openCountEl.textContent = open;
      doneCountEl.textContent = done;
    }

    function btn(label, cls, onClick){
      const b = document.createElement("button");
      b.className = `btn ${cls}`; b.textContent = label; b.onclick = onClick; return b;
    }

    /************ Actions ************/
    function add(text){
      if(!text) return;
      tasks.unshift({ id: uid(), text, created: Date.now(), completed:false });
      save();
    }
    function toggleDone(id){
      const t = tasks.find(x=>x.id===id);
      if(!t) return;
      t.completed = !t.completed;
      save();
    }
    function commitEdit(id, newText){
      const t = tasks.find(x=>x.id===id);
      if(!t) return;
      t.text = newText || t.text;
      delete t._edit;
      save();
    }
    function del(id){
      tasks = tasks.filter(x=>x.id!==id);
      save();
    }
    function clearDone(){
      tasks = tasks.filter(x=>!x.completed);
      save();
    }

    /************ Import / Export ************/
    function exportJson(){
      const blob = new Blob([JSON.stringify(tasks,null,2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "todooffline-tasks.json";
      a.click();
      URL.revokeObjectURL(a.href);
    }
    function importJson(file){
      const r = new FileReader();
      r.onload = () => {
        try{
          const arr = JSON.parse(r.result);
          if(Array.isArray(arr)){ tasks = arr; save(); }
          else alert("Invalid JSON");
        }catch{ alert("Invalid JSON") }
      };
      r.readAsText(file);
    }

    /************ UI wiring ************/
    const input = document.getElementById("taskInput");
    const addBtn = document.getElementById("addBtn");
    const clrBtn = document.getElementById("clearDoneBtn");
    const exportBtn = document.getElementById("exportBtn");
    const importInput = document.getElementById("importInput");

    addBtn.onclick = () => { add(input.value.trim()); input.value=""; input.focus(); };
    input.addEventListener("keydown", e=>{
      if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); addBtn.click(); }
    });
    clrBtn.onclick = () => { if(confirm("Remove all completed tasks?")) clearDone(); };
    exportBtn.onclick = exportJson;
    importInput.onchange = e => { const f=e.target.files?.[0]; if(f) importJson(f); e.target.value=""; };

    render();
  </script>
</body>
</html>
